## Сервер

- [Инициализация сервера](#Инициализация-сервера)
- [Свойства сервера](#Свойства-сервера)
- [События](#События)
- [Запуск сервера](#Запуск-сервера)
- [Остановить сервер](#Остановить-сервер)
- [Middlewares](#Middlewares)
- [Маршрутизация](#Маршрутизация)
- [Клиенты](#Клиенты)

Сервер управляет подключениями пользователей, поддерживает маршрутизацию 
сообщений, групповую рассылку сообщений, управляет групповыми рассылками, 
поддерживает горизонтальное масштабирование.

Сервер может отправить сообщение клиенту одним из 3 способов:

- Отправить сообщение асинхронно, не ожидая ответ
- Отправить сообщение асинхронно, ожидая ответ в callback
- Отправить сообщение асинхронно, ожидая ответ в синхронном стиле

При горизонтальном масштабировании используются клоны (копии сервера).
Клоны рассылают групповые сообщения друг другу и своим клиентам, таким 
образом групповое сообщение получают клиенты всех клонов. Клоны обмениваются 
информацией, об известных им клонах, с другими клонами. Таким образом 
строятся каналы связи между клонами, даже если изначально клоны не знали друг
о друге.  

Для работы с `WebSockets`, сервер использует легкий и быстрый [ws](https://github.com/websockets/ws).

### Инициализация сервера

```js
  const jrfWS = require('jrf-ws');
  const https = require('https');
  const fs = require('fs');

  // Создаем экземпляр сервера/клона
  const server = new jrfWS.Server({
    id: 'server', 
    port: 4000
  });
 
  server.start();

  // Создаем экземпляр сервера/клона c защищенным соединением
  const cloneParams = {
    id: 'clone',
    port: 4001,
  };

  const clone = new jrfWS.Server(cloneParams);

  const serverHttps = https.createServer({
    cert: fs.readFileSync(`${process.cwd()}/tests/keys/cert.pem`),
    key: fs.readFileSync(`${process.cwd()}/tests/keys/key.pem`)
  });

  serverHttps.listen(4001);
  clone.start({server: serverHttps});
```  

Конструктор содержит параметры, все параметры не обязательны, кроме `url`:

| name | type | default | description |
| --- | --- | --- | --- |
| id | string | generate | id сервера. По умолчанию генерируется автоматически. Но если используется горизонтальное масштабирование, то лучше задать явно. id у каждого клона должен быть уникальным |  
| port | number | 3000 | Порт на котором сервер будет принимать соединения |
| url | string |  | Адрес текущего клона. Если адрес задан, то при подключении к удаленному клону, он будет передан. Удаленный клон попытается подключиться по данному адресу |
| data | * |  | Любые пользовательские данные |
| authFnIn | function |  | Синхронная или асинхронная функция аутентификации входящих соединений от клонов. Отрабатывает при событии подключения клона. На входе принимает параметр `authValue` от подключающегося клона. Этим значением может быть что угодно, например токен или api key. Если вернет `false` - то подключение разрывается. Если вернет `true` - то клону разрешается подключение. |
| authFnOut | function |  | Синхронная или асинхронная функция аутентификации исходящих соединений к клонам. Отрабатывает при событии подключения к клону. На входе принимает объект клиента клона (client) к которому подключается. Вернуть должен `authValue`. По этому значению клон будет производить аутентификацию. Этим значением может быть что угодно, например токен или api key. |

### Свойства сервера

| name | type | description |
| --- | --- | --- |
| wss | Object | Объект сервера пакета `ws` работающий с `websocket` |
| id | string | id сервера. По умолчанию генерируется автоматически. Но если используется горизонтальное масштабирование, то лучше задать явно. id у каждого клона должен быть уникальным |  
| port | number | Порт на котором сервер будет принимать соединения |
| url | string | Адрес текущего клона. Если адрес задан, то при подключении к удаленному клону, он будет передан. Удаленный клон попытается подключиться по данному адресу |
| data | * | Любые пользовательские данные |
| authFnIn | function | Синхронная или асинхронная функция аутентификации входящих соединений от клонов. Отрабатывает при событии подключения клона. На входе принимает параметр `authValue` от подключающегося клона. Этим значением может быть что угодно, например токен или api key. Если вернет `false` - то подключение разрывается. Если вернет `true` - то клону разрешается подключение. |
| authFnOut | function | Синхронная или асинхронная функция аутентификации исходящих соединений к клонам. Отрабатывает при событии подключения к клону. На входе принимает объект клиента клона (client) к которому подключается. Вернуть должен `authValue`. По этому значению клон будет производить аутентификацию. Этим значением может быть что угодно, например токен или api key. |
| active | boolean | Состояние сервера. `true` - запущен, `false` - остановлен |
| routes | Set | Маршруты, которые маршрутизируют пользовательские сообщения `class Route` |
| groups | Object | Менеджер групп `class Groups` |
| clients | Object | Клиентские соединения: Ключ - id клиентского соединения со стороны сервера (сгенерирован автоматически); Значение - объект клиентского соединения `class WS` |
| clones | Object | Менеджер клонов `class Clones` |

### События

Пример подписки на событие `error`

```js
server.on('error', ({server, error}) => console.error(error));
```

#### start 

Происходит в момент старта сервера

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` | 

#### connection

Происходит, когда клиент создает `socket` соединение

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` | 

#### stop

Происходит в момент остановки сервера

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` |

#### close

Происходит в момент закрытия `socket` соединения

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` |

#### closeClient

Происходит в момент закрытия клиентского `socket` соединения

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` |
| client | Object | Объект клиентского соединения `class WS` |

#### error

Происходит в момент ошибки

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` |
| error | Object | Ошибка |

#### noRouting

Происходит если сообщение не прошло ни по одному из маршрутов

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` |
| ws | Object | Объект клиентского соединения `class WS` |
| groups | Object | Менеджер групп `class Groups` |
| data | * | Данные сообщения |
| mes | Object | Пользовательское сообщение `route`, `act`, `data` |
| raw | Object | Полное сообщение, содержащее пользовательское сообщение (mes) и системную информацию |

#### auth

Происходит, когда удаленный клон успешно проходит аутентификацию

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` |
| clone | Object | Объект клиентского соединения, удаленного клона `class WS` |

#### authError

Происходит, когда удаленный клон не проходит аутентификацию

Параметры:

| name | type | description |
| --- | --- | --- |
| server | Object | Сервер `class Server` |
| clone | Object | Объект клиентского соединения, удаленного клона `class WS` |

### Запуск сервера

Запуск сервера производит метод `start`, который принимает не обязательные параметры:

| name | type | description |
| --- | --- | --- |
| opts | Object | Объект опций сервера пакета [ws](https://github.com/websockets/ws/blob/master/doc/ws.md#new-websocketserveroptions-callback) |

При успешном запуске, сервер переходит в активное состояние `active = true;`.
Запускается менеджер клонов, который обменивается информацией с другими клонами.

### Остановить сервер

Остановку сервера производит метод `stop`, который принимает не обязательные параметры:

| name | type | description |
| --- | --- | --- |
| cb | function | Функция обратного вызова, отработает после остановки сервера |

Сервер переходит в не активное состояние `active = false;`.
Останавливается менеджер клонов, который обменивается информацией с другими клонами.

### Middlewares

Каждое входящее сообщение, перед тем как пройти маршрутизацию, проходит
`middlewares`.

`Middleware` добавляется методом `use` который принимает функцию `fn`, 
синхронную или асинхронную.

Функция `fn` принимает параметры:

| name | type | description |
| --- | --- | --- |
| ws | Object | Клиент пославший сообщение, объект клиентского соединения `class WS` |
| groups | Object | Менеджер групп `class Groups` |
| mes | Object | Входящее пользовательское сообщение, содержит: `route`, `act`, `data` |
| stop | function | Синхронная функция, выполнение которой останавливает дальнейшую маршрутизацию |
| raw | Object | Полное сообщение, содержащее пользовательское сообщение (mes) и системную информацию |

```js
  server.use(({ws, groups, mes, stop, raw}) => {

    const login = mes.route === 'login';
    const token = ws.userData.token;
    if (token || login) return;

    stop();
    return {error: 'bad token'};

  });
```

### Маршрутизация

Для добавления маршрута, используется метод `addRoute`

Метод принимает параметры:

| name | type | description |
| --- | --- | --- |
| groups | Object | Менеджер групп `class Groups` |
| route | string | Маршрут |
| act | string | Действие относительно маршрута |
| handler | function | Обязательный параметр. Синхронная или асинхронная функция, обработчик входящего сообщения, попадающего под маршрутизацию |

Обработчик `handler` принимает параметры:

| name | type | description |
| --- | --- | --- |
| ws | Object | Клиент пославший сообщение, объект клиентского соединения `class WS` |
| groups | Object | Менеджер групп `class Groups` |
| data | * | Данные сообщения |
| mes | Object | Входящее пользовательское сообщение, содержит: `route`, `act`, `data` |
| stop | function | Синхронная функция, выполнение которой останавливает дальнейшую маршрутизацию |
| raw | Object | Полное сообщение, содержащее пользовательское сообщение (mes) и системную информацию |

Примеры: 

```js
  // Обработчик будут проходить все сообщения
  server.addRoute({
    handler: ({ws, groups, data, mes, stop, raw}) => {
      console.log(`all messages`);
    }
  });

  // Обработчик будут проходить сообщения содержащие 
  // route === 'login' и содержащие или не содержащие act
  server.addRoute({
    route: 'login',
    handler: async ({ws, groups, data, mes, stop, raw}) => {

      const login = data.user.login;
      const password = data.user.password;

      const token = await auth({login, password});
      if (!token) {
        stop();
        return;
      }

      ws.userData = {token};

    }
  });

  // Обработчик будут проходить сообщения содержащие 
  // route === 'users' и содержащие или не содержащие act
  server.addRoute({
    route: 'users',
    handler: ({ws, groups, data, mes, stop, raw}) => {
      console.log(`users messages`);
    }
  });

  // Обработчик будут проходить сообщения содержащие 
  // route === 'users' и содержащие act === 'add'
  server.addRoute({
    route: 'users',
    act: 'add',
    handler: ({ws, groups, data, mes, stop, raw}) => {
      console.log(`add users messages`);
    }
  });
``` 

### Клиенты

Клиентские соединения хранятся в свойстве `clients`. Ключ - `id` клиентского
соединения со стороны сервера (сгенерирован автоматически). Значение - 
объект клиентского соединения `class WS`. Так же клиентское соединение 
доступно в `middlewares` и `handler` маршрутизации, в виде параметра `ws`.

Каждому клиенту можно отправить сообщение вызвав асинхронный метод 
`asyn sendMes`. Принимает параметры:

| name | type | description |
| --- | --- | --- |
| route | string | Маршрут |
| act | string | Действие которое требуется выполнить относительно пути |
| data | * | Данные которые требуется отправить |
| opts | Object | Опции пакета [ws](https://github.com/websockets/ws/blob/master/doc/ws.md#websocketsenddata-options-callback) |
| cbAfterSend | function | `callback` который выполнится после того как сообщение будет отправлено, пакет [ws](https://github.com/websockets/ws/blob/master/doc/ws.md#websocketsenddata-options-callback) |
| cbAfterRes | function | `callback` который выполнится по возвращению ответа на отправленное сообщение |
| awaitRes | boolean | Ожидание асинхронного ответа в синхронном стиле. По умолчанию `false` |
| timeout | number | Время (мс) ожидания ответа, по истечению которого будет вызвано исключение. По умолчанию `10000` |

Примеры:

```js
// Обработчик будут проходить все сообщения
server.addRoute({
  handler: async ({ws, groups, data, mes, stop, raw}) => {

    // Отправим сообщение асинхронно, не ожидая ответ
    await ws.sendMes({data: {description: 'test message'}});

    // Отправим сообщение асинхронно, ожидая ответ в синхронном стиле
    const res = await ws.sendMes({
      route: 'math',
      act: 'add',
      data: {a: 1, b: 2},
      awaitRes: true
    });

    // Отправим сообщение асинхронно, ожидая ответ в callback
    const cbAfterRes = ({error, res}) => {
      console.log(res);
    };

    await ws.sendMes({
      route: 'math',
      act: 'add',
      data: {a: 5, b: 3},
      cbAfterRes
    });

  }
});
```