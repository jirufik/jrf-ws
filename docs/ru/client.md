## Клиент

- [Инициализация клиента](#Инициализация-клиента)
- [События](#События)
- [Запуск клиента](#Запуск-клиента)
- [Остановить клиента](#Остановить-клиента)
- [Информация о клиенте](#Информация-о-клиенте)
- [Добавить адрес клона](#Добавить-адрес-клона)
- [Удалить адрес клона](#Удалить-адрес-клона)
- [Установить следующий адрес клона](#Установить-следующий-адрес-клона)
- [Подписаться на группу](#Подписаться-на-группу)
- [Отписаться от сообщений группы](#Отписаться-от-сообщений-группы)
- [Получить список групп](#Получить-список-групп)
- [Middlewares](#Middlewares)
- [Маршрутизация](#Маршрутизация)
- [Послать сообщение серверу](#Послать-сообщение-серверу)
- [Отправить групповое сообщение](#Отправить-групповое-сообщение)

Клиент поддерживает маршрутизацию сообщений, групповую рассылку сообщений, 
подписку на групповые рассылки.

Отправить сообщение можно одним из 3 вариантов:

- Отправить сообщение асинхронно, не ожидая ответ
- Отправить сообщение асинхронно, ожидая ответ в callback
- Отправить сообщение асинхронно, ожидая ответ в синхронном стиле

Можно задать адреса нескольких клонов (серверов), при разрыве соединения, 
клиент будет пытаться подключиться к клонам (серверам) по алгоритму Round-robin.

Для работы клиента с клонами не требуются липкие сессии.

Клиент имеет две реализации:

- Web реализация, основана на [WebScoket](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- Node.js реализация, основана на [ws](https://github.com/websockets/ws)

Реализации обладают почти идентичным функционалом, различия не существенны.

### Инициализация клиента

Web клиент

```js
import jrfWS from 'jrf-ws-3';

// Создаем экземпляр клиента
const client = new jrfWS.WebClient({
id: 'client',
url: 'ws://localhost:4000'
});
```  

Node.js клиент

```js
const jrfWS = require('jrf-ws-3');

// Создаем экземпляр клиента
const client = new jrfWS.Client({
id: 'client',
url: 'ws://localhost:4000'
});
```  

Конструктор содержит параметры, все параметры не обязательны, кроме `url`:

| name | type | default | description |
| --- | --- | --- | --- | 
| id | string | generate | id клиента. Если не задать то генерируется автоматически. |
| url | string/Array |  | Адрес сервера `'ws://localhost:3000'`. Можно задать массив адресов клонов `['ws://remote1:3000', 'wss://remote2:4000']`. Если происходит разрыв соединения, то клиент пробует подключиться к следующему клону по (round-robin) |
| data | Object | {} | Любые пользовательские данные |
| reconnect | boolean | true | Признак переподключения при разрыве соединения |
| reconnectTimeout | number | 2000 | Пауза между попытками переподключения |
| awaitResTimeout | number | 10000 | Сколько времени ожидать ответ, на отправленное сообщение, для функции обратного вызова или синхронного стиля |
| awaitCycleTimeout | number | 15 | Асинхронная пауза между итерациями проверки ответа на сообщение |
| attempts | number | 0 | Количество попыток переподключения, если 0 то бесконечное переподключение |
| silent | boolean | true | Не выводить в консоль сообщения об ошибках |

### События

Пример подписки на событие `error`

```js
client.on('error', ({client, error}) => console.error(error));
```

#### start 

Происходит в момент старта клиента

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` | 

#### open 

Происходит в момент установки `socket` соединения между клиентом и клоном (сервером)

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` | 

#### stop 

Происходит в момент остановки клиента

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` | 

#### close 

Происходит в момент закрытия `socket` соединения

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` | 

#### reconnect 

Происходит в момент переподключения

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` | 

#### error 

Происходит в момент ошибки

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` |
| error | object | Ошибка | 

#### noRouting 

Происходит если сообщение не прошло ни по одному из маршрутов

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` |
| ws | object | Объект клиентского соединения. Класс `WS` |
| data | * | Данные сообщения |

#### auth 

Происходит в момент когда, клон прошел аутентификацию

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` |  

#### authError 

Происходит в момент когда, клон не прошел аутентификацию

Параметры:

| name | type | description |
| --- | --- | --- |
| client | object | Клиент. Класс `Client` |
| error | object | Ошибка аутентификации |

### Запуск клиента

Для запуска клиента служит метод `start`, который может принимать параметры:

| name | type | description |
| --- | --- | --- |
| url | string | Адрес сервера `'ws://localhost:3000'`. Можно задать массив адресов клонов `['ws://remote1:3000', 'wss://remote2:4000']`. Если происходит разрыв соединения, то клиент пробует подключиться к следующему клону по (round-robin). Если адрес(а) не задан, то используется заданный при создании экземпляра клиента |
| reconnect | boolean | Признак переподключения при разрыве соединения |
| reconnectTimeout | number | Пауза между попытками переподключения |
| attempts | number | Количество попыток переподключения, если 0 то бесконечное переподключение |
| opts | Object | Только для Node.js `Client`, опции пакета [ws](https://github.com/websockets/ws/blob/master/doc/ws.md#new-websocketaddress-protocols-options) |

### Остановить клиента

Для остановки клиент служит метод `stop`, который может принимать параметры:

| name | type | description |
| --- | --- | --- |
| cb | function | Только для Node.js `Client`. Функция обратного вызова будет вызвана после остановки клиента |

### Информация о клиенте

Получить информацию о клиенте можно, вызвав метод `getInfo`, в ответ вернет:

| name | type | description |
| --- | --- | --- |
| id | string | id клиента |
| url | string | Адрес текущего клона (сервера) `'ws://remote1:3000'` |
| urls | Array | Адреса клонов (серверов) `['ws://remote1:3000', 'wss://remote2:4000']` |
| timeouts | Object | Объект содержащий в себе таймауты: `reconnectTimeout`, `awaitResTimeout`, `awaitCycleTimeout` |
| attempts | number | Количество попыток переподключения |
| data | Object | Любые пользовательские данные |
| groups | Array | Массив `id` групп на которые подписан клиент |

### Добавить адрес клона

Для добавления адреса клона (сервера), служит метод `addUrl`

| name | type | description |
| --- | --- | --- |
| url | string/Array | Адрес сервера `'ws://localhost:3000'`. Можно задать массив адресов клонов `['ws://remote1:3000', 'wss://remote2:4000']` |

### Удалить адрес клона

Для удаления адреса(ов) клона (сервера), служит метод `deleteUrl`

| name | type | description |
| --- | --- | --- |
| url | string | Адрес сервера `'ws://localhost:3000'`, который требуется удалить, если адрес не задан, то удаляются все адреса |

### Установить следующий адрес клона

Вызов метод `nextUrl`, устанавливает текущим адресом подключения следующий сервер
по алгоритму `round-robin`, но переподключение не происходит. Возвращает: 

| name | type | description |
| --- | --- | --- |
| url | string | Адрес установленного клона (сервера) |

### Подписаться на группу

Подписка на сообщения группы происходит методом `subscribe`.
Параметры:

| name | type | description |
| --- | --- | --- |
| id | string | id группы |

### Отписаться от сообщений группы

Отписаться от сообщений группы, можно выполнив метод `unsubscribe`.
Параметры:

| name | type | description |
| --- | --- | --- |
| id | string | id группы |

### Получить список групп

Получить список групп, на которые подписан клиент, можно вызвав 
метод `getMyGroups`. Вернет массив `id` групп.

### Middlewares

Каждое входящее сообщение, перед тем как пройти маршрутизацию, проходит
`middlewares`.

`Middleware` добавляется методом `use` который принимает функцию `fn`, 
синхронную или асинхронную.

Функция `fn` принимает параметры:

| name | type | description |
| --- | --- | --- |
| ws | Object | Клиент, объект клиентского соединения `class WS` |
| mes | Object | Входящее пользовательское сообщение, содержит: `route`, `act`, `data` |
| stop | function | Синхронная функция, выполнение которой останавливает дальнейшую маршрутизацию |
| raw | Object | Полное сообщение, содержащее пользовательское сообщение (mes) и системную информацию |

```js
  client.use(({ws, mes, stop, raw}) => {

    const token = mes.data.token;
    if (token) return;

    stop();
    return {error: 'bad token'};

  });
```

### Маршрутизация

Для добавления маршрута, используется метод `addRoute`

Метод принимает параметры:

| name | type | description |
| --- | --- | --- |
| route | string | Маршрут |
| act | string | Действие относительно маршрута |
| handler | function | Обязательный параметр. Синхронная или асинхронная функция, обработчик входящего сообщения, попадающего под маршрутизацию |

Обработчик `handler` принимает параметры:

| name | type | description |
| --- | --- | --- |
| ws | Object | Клиент, объект клиентского соединения `class WS` |
| data | * | Данные сообщения |
| stop | function | Синхронная функция, выполнение которой останавливает дальнейшую маршрутизацию |

Примеры: 

```js
  // Обработчик будут проходить все сообщения
  client.addRoute({
    handler: ({ws, data, stop}) => {
      console.log(`all messages`);
    }
  });

  // Обработчик будут проходить сообщения содержащие 
  // route === 'users' и содержащие или не содержащие act
  client.addRoute({
    route: 'users',
    handler: ({ws, data, stop}) => {
      console.log(`users messages`);
    }
  });

  // Обработчик будут проходить сообщения содержащие 
  // route === 'users' и содержащие act === 'add'
  client.addRoute({
    route: 'users',
    act: 'add',
    handler: ({ws, data, stop}) => {
      console.log(`add users messages`);
    }
  });
```

### Послать сообщение серверу

Для отправки сообщения серверу, выполняется асинхронный метод `async sendMes`.
Принимает параметры:

| name | type | description |
| --- | --- | --- |
| route | string | Маршрут |
| act | string | Действие которое требуется выполнить относительно пути |
| data | * | Данные которые требуется отправить |
| opts | Object | Только для Node.js `Client`, опции пакета [ws](https://github.com/websockets/ws/blob/master/doc/ws.md#websocketsenddata-options-callback) |
| cbAfterRes | function | `callback` который выполнится по возвращению ответа на отправленное сообщение |
| cbAfterSend | function | Только для Node.js `Client`, callback который выполнится после того как сообщение будет отправлено, пакет [ws](https://github.com/websockets/ws/blob/master/doc/ws.md#websocketsenddata-options-callback) |
| awaitRes | boolean | Ожидание асинхронного ответа в синхронном стиле. По умолчанию `false` |
| timeout | number | Время (мс) ожидания ответа, по истечению которого будет вызвано исключение. По умолчанию `10000` |

Примеры:

```js
// Отправим сообщение асинхронно, не ожидая ответ
await client.sendMes({data: {description: 'test message'}});

// Отправим сообщение асинхронно, ожидая ответ в синхронном стиле
const res = await client.sendMes({
  route: 'math',
  act: 'add',
  data: {a: 1, b: 2},
  awaitRes: true
});

// Отправим сообщение асинхронно, ожидая ответ в callback
const cbAfterRes = ({error, res}) => {
  console.log(res);
};

await client.sendMes({
  route: 'math',
  act: 'add',
  data: {a: 5, b: 3},
  cbAfterRes
});
```

### Отправить групповое сообщение

Для отправки группового сообщения, выполняется асинхронный метод `async sendMesToGroup`.
Принимает параметры:

| name | type | description |
| --- | --- | --- |
| id | null/string/Array | id группы. Если не задан, сообщение рассылается всем группам. Если задан id, то посылается в группу. Если задан массив id, то рассылается указанным группам |
| route | string | Маршрут |
| act | string | Действие которое требуется выполнить относительно пути |
| data | * | Данные которые требуется отправить |
| notSendMe | boolean | `true` исключить получение сообщения текущим клиентом. По умолчанию `false` |

Примеры:

```js
// Отправить сообщение в группу truckers
await client.sendMesToGroup({
    id: 'truckers',
    data: 'hi guys from client'
  });

// Отправить сообщение в группы truckers и truckers2
await client.sendMesToGroup({
    id: ['truckers', 'truckers2'],
    data: 'truckers2 is amazing game'
  });

// Отправить сообщение во все группы
await client.sendMesToGroup({
    data: 'all groups'
  });
```